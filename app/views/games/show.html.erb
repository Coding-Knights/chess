<div class="col-8 offset-2 text-center">
  <h2><%= @game.name %></h2>
</div>

<br />

<div class="row justify-content-center">
    <ul>
        <% if @game.state == 'Forfeited' %>
            <p id='forfeit_loser'><%= User.find(@game.loser_id).email %> forfeited!</p>
            <p id='forfeit_winner'><%= User.find(@game.winner_id).email %> WINS!</p>
        <% end %>
    </ul>
</div>

<!-- PRELIMINARY CODE FOR CAPTURE BOXES  -->
<div class="capture_box left-box">
  <% @white_captured_pieces.each do |piece| %>
    <%= content_tag :div, data: {:piece_id => piece.id} do -%>
        <%= piece.piece_type %>
    <% end -%> 
  <% end %> 
</div>
<div class="capture_box right-box">
  <% @black_captured_pieces.each do |piece| %>
    <%= content_tag :div, data: {:piece_id => piece.id} do -%>
        <%= piece.piece_type %>
    <% end -%> 
  <% end %> 
</div>

<br />

<div class="player-two col-6 offset-3 text-center">
  <%= render partial: 'player_two' %>
</div>

<br />

<div class="game-board col-lg-auto">
  <%= render partial: 'board' %>
</div>

<br />

<div class="player-one col-6 offset-3 text-center">
  <%= render partial: 'player_one' %>
</div>


<br />
<br />
<%= current_user.email %>
<br />


<h2 class="text-center">
<%= link_to 'FORFEIT', forfeit_path(@game), method: :get, class: "btn btn-danger btn-lg", id: 'Forfeit' %>
<%= link_to "DESTROY THIS GAME", game_path, :method=> :delete, :class=>"btn btn-danger btn-lg" %>

</h2>

<% if @game.white_player_id == current_user.id %>
  <div class = "row">
    <div class = "col-xs-10 col-xs-offset-1 text-center">
      <%= link_to 'Castle Kingside', game_castle_kingside_path(@game), :class => 'btn btn-info' %>
      <%= link_to 'Castle Queenside', game_castle_queenside_path(@game), :class => 'btn btn-info' %>
    </div>
  </div>
<% end %>
<br>
<table class="board">
  <% 8.times do |x| %>
    <%= '<tr>'.html_safe %>
    <% 8.times do |y| %>
      <% piece_result = @pieces.find { |p| p.y_position == y && p.x_position == x } %>
      <%= '<td>'.html_safe + piece_present?(piece_result, @game, x, y) + '</td>'.html_safe %>
    <% end %> 
  <% end %>
</table>
<h3 class="text-center"><%= black_player %></h3>
<% if @game.black_player_id == current_user.id %>
  <div class = "row">
    <div class = "col-xs-10 col-xs-offset-1 text-center">
      <%= link_to 'Castle Kingside', game_castle_kingside_path(@game), :class => 'btn btn-info' %>
      <%= link_to 'Castle Queenside', game_castle_queenside_path(@game), :class => 'btn btn-info' %>
    </div>
  </div>
<% end %>


<script type='text/javascript'>
  function init_draggables_and_droppables() { 
      $('.piece').draggable({
        containment: '.gameboard',
        snap: '.tile',
        cursor: 'crosshair',
        scroll: false,
        revert: 'invalid'
      });

      $('.tile').droppable({
        drop: function( event, ui ) {
          piece_id = ui.draggable.data('piece-id')
          x_position = $(this).data('x-coord')
          y_position = $(this).data('y-coord')
          $.ajax({
            url: `/pieces/${piece_id}?x_position=${x_position}&y_position=${y_position}`,
            type: 'PUT'
          });
        }
      });
    }
  
  $(function() {
    init_draggables_and_droppables();
  });
</script>